<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>AQUA SQUAT - SPLASH EDITION</title>
  <style>
    :root{
      --bg:#000b14; --fg:#e7edf7; --blue:#00d2ff;
      --perfect: #00fff2; --great: #00a2ff; --good: #70ffeb; --miss: #ff3333;
    }
    body{ margin:0; background:var(--bg); color:var(--fg); overflow:hidden; font-family:'Segoe UI', sans-serif; }
    canvas{ width:100vw; height:100vh; display:block; }
    
    .seekbar-container { 
      position: fixed; top: 20px; left: 10%; width: 80%; height: 10px; 
      background: rgba(0, 210, 255, 0.1); border-radius: 20px; overflow: hidden; 
      z-index: 150; border: 1px solid rgba(0, 210, 255, 0.3);
    }
    #seekbar-fill { 
      width: 0%; height: 100%; 
      background: linear-gradient(90deg, #00d2ff, #0055ff);
      box-shadow: 0 0 15px var(--blue);
    }
    .time-label { 
      position: fixed; top: 40px; right: 10%; font-size: 20px; font-weight: 900; 
      font-family: monospace; color: var(--blue); z-index: 150; 
      text-shadow: 0 0 8px var(--blue);
    }

    .ui{ position:absolute; inset:0; pointer-events:none; z-index:100; display:flex; flex-direction:column; align-items:center; }
    .score-area{ margin-top:120px; text-align:center; }
    .combo{ font-size:28px; font-weight:900; color: #fff; text-shadow: 0 0 15px var(--blue); }
    .judge-text{ font-size:64px; font-weight:900; font-style:italic; margin-top:10px; }
    
    .overlay{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,11,20,0.9); z-index:200; }
    .panel{ 
      width:85%; max-width:400px; padding:30px; background:rgba(10,30,50,0.95); 
      border-radius:30px; text-align:center; border:2px solid var(--blue); 
      box-shadow: 0 0 40px rgba(0,210,255,0.3);
    }
    .btn{ 
      padding:20px; background: linear-gradient(135deg, #00d2ff, #0055ff); 
      color:#fff; border:none; border-radius:15px; font-weight:bold; width:100%; 
      font-size:24px; cursor:pointer; margin-top: 25px; box-shadow: 0 5px 15px rgba(0,210,255,0.4);
    }
    .hidden{ display:none !important; }
  </style>
</head>
<body>

<div class="seekbar-container"><div id="seekbar-fill"></div></div>
<div class="time-label" id="timer">02:30</div>

<div class="ui">
  <div class="score-area">
    <div id="combo" class="combo"></div>
    <div id="judgeLabel" class="judge-text"></div>
  </div>
</div>

<div class="overlay" id="ovStart">
  <div class="panel">
    <h1 style="margin:0; color:var(--blue); text-shadow: 0 0 10px var(--blue);">AQUA SQUAT</h1>
    <p style="font-size:13px; color:#8af;">スクワットの衝撃で水を弾けさせろ！</p>
    <div style="text-align:left; margin:20px 0;">
      <label style="font-size:12px;">判定感度: <span id="sens-val" style="color:var(--blue);">20</span></label>
      <input type="range" id="sens-slider" min="5" max="50" value="20" style="width:100%;">
      <div style="height:4px; background:#111; margin-top:10px; border-radius:2px; overflow:hidden;">
        <div id="sens-bar" style="width:0%; height:100%; background:var(--blue);"></div>
      </div>
    </div>
    <button class="btn" id="btnStart">START SESSION</button>
  </div>
</div>

<div class="overlay hidden" id="ovResult">
  <div class="panel">
    <h2>SESSION CLEAR</h2>
    <div id="res-stats" style="font-size: 20px; margin: 20px 0;"></div>
    <button class="btn" onclick="location.reload()">REPLAY</button>
  </div>
</div>

<canvas id="game"></canvas>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const seekbarFill = document.getElementById("seekbar-fill");
  const timerLabel = document.getElementById("timer");
  const sensSlider = document.getElementById("sens-slider");
  const sensValLabel = document.getElementById("sens-val");
  const sensBar = document.getElementById("sens-bar");
  const btnStart = document.getElementById("btnStart");
  const ovStart = document.getElementById("ovStart");
  const ovResult = document.getElementById("ovResult");

  let W, H, audioCtx;
  const resize = () => { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; };
  window.addEventListener("resize", resize);
  resize();

  const DURATION = 150; 
  const squatCycleSec = 1.0; 
  const cycle = [0, 1, 2, 3, 4, 3, 2, 1];
  
  let sensitivity = 20;
  let lastJudgeTime = 0;
  const particles = [];
  const waves = [];

  const state = { 
    running: false, startTime: 0, notes: [], 
    combo: 0, maxCombo: 0, flash: 0, hitTime: 0, shake: 0,
    bgFlash: 0,
    stats: { PERFECT: 0, GREAT: 0, GOOD: 0, MISS: 0 }
  };

  sensSlider.oninput = () => {
    sensitivity = parseInt(sensSlider.value);
    sensValLabel.textContent = sensitivity;
  };

  // 水しぶきパーティクルクラス
  class Splash {
    constructor(x, y, color) {
      this.x = x; this.y = y;
      this.color = color;
      this.radius = Math.random() * 4 + 2;
      this.vx = (Math.random() - 0.5) * 15;
      this.vy = -Math.random() * 20 - 5; // 上に跳ねる
      this.gravity = 0.8;
      this.life = 1.0;
    }
    update() {
      this.vx *= 0.95;
      this.vy += this.gravity;
      this.x += this.vx;
      this.y += this.vy;
      this.life -= 0.02;
    }
    draw() {
      ctx.globalAlpha = this.life;
      ctx.fillStyle = this.color;
      ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // 波紋クラス
  class Wave {
    constructor(x, y) {
      this.x = x; this.y = y; this.r = 0; this.life = 1.0;
    }
    update() { this.r += 5; this.life -= 0.02; }
    draw() {
      ctx.strokeStyle = `rgba(0, 210, 255, ${this.life})`;
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.ellipse(this.x, this.y, this.r, this.r*0.3, 0, 0, Math.PI*2); ctx.stroke();
    }
  }

  function playSound(freq, dur) {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, t);
    osc.frequency.exponentialRampToValueAtTime(freq/2, t + dur);
    g.gain.setValueAtTime(0.3, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(); osc.stop(t + dur);
  }

  const images = [];
  const files = ["１スクワットアニメ.jpg","２スクワットアニメ.jpg","３スクワットアニメ.jpg","４スクワットアニメ.jpg","５スクワットアニメ.jpg"];
  files.forEach((src, i) => { const img = new Image(); img.src = src; images[i] = img; });

  function buildChart() {
    let t = 3.0;
    while(t < DURATION) {
      state.notes.push({ t, judged: false });
      t += 1.0; // スクワット1回につき1ノーツ（基本）
    }
  }

  function applyJudge(text, color, shake, key) {
    state.combo++;
    state.maxCombo = Math.max(state.maxCombo, state.combo);
    state.stats[key]++;
    state.flash = 1.0; state.hitTime = performance.now(); state.shake = shake;
    state.bgFlash = 0.2;
    
    document.getElementById("judgeLabel").textContent = text;
    document.getElementById("judgeLabel").style.color = color;
    document.getElementById("combo").textContent = state.combo > 1 ? state.combo + " COMBO" : "";
    
    // 水演出
    waves.push(new Wave(W/2, H*0.82));
    for(let i=0; i<20; i++) particles.push(new Splash(W/2, H*0.82, color));
    
    playSound(key === 'PERFECT' ? 400 : 250, 0.3);
    if(navigator.vibrate) navigator.vibrate(key === 'PERFECT' ? 60 : 30);
  }

  function loop() {
    if (!state.running) return;
    const nowMs = performance.now();
    const nowSec = (nowMs - state.startTime) / 1000;
    const remaining = Math.max(0, DURATION - nowSec);

    seekbarFill.style.width = (nowSec / DURATION) * 100 + "%";
    timerLabel.textContent = (Math.floor(remaining/60)).toString().padStart(2,'0') + ":" + (Math.floor(remaining%60)).toString().padStart(2,'0');

    if(nowSec > DURATION) {
      state.running = false;
      ovResult.classList.remove("hidden");
      document.getElementById("res-stats").innerHTML = `PERFECT: ${state.stats.PERFECT}<br>MAX COMBO: ${state.maxCombo}`;
      return;
    }

    // 背景 & 水面演出
    ctx.fillStyle = "#000b14"; ctx.fillRect(0, 0, W, H);
    if(state.bgFlash > 0) {
      ctx.fillStyle = `rgba(0, 210, 255, ${state.bgFlash})`;
      ctx.fillRect(0, 0, W, H);
      state.bgFlash *= 0.9;
    }

    // キャラ
    const step = Math.floor(((nowSec % squatCycleSec) / squatCycleSec) * cycle.length);
    const img = images[cycle[step]];
    if (img && img.complete) {
      const scale = Math.min(W * 0.8 / img.width, H * 0.5 / img.height);
      ctx.drawImage(img, W/2 - (img.width*scale)/2, H/2 - (img.height*scale)/2 - 50, img.width*scale, img.height*scale);
    }

    const targetY = H * 0.82, targetX = W / 2, speed = 550;

    // 波紋と水しぶきの描画
    waves.forEach((w, i) => { w.update(); w.draw(); if(w.life <= 0) waves.splice(i, 1); });
    particles.forEach((p, i) => { p.update(); p.draw(); if(p.life <= 0) particles.splice(i, 1); });

    // 判定枠（水たまりのような光）
    ctx.beginPath();
    ctx.strokeStyle = state.flash > 0 ? `rgba(0, 210, 255, ${state.flash})` : "rgba(0, 210, 255, 0.2)";
    ctx.lineWidth = 4;
    ctx.ellipse(targetX, targetY, 60, 20, 0, 0, Math.PI*2);
    ctx.stroke();
    state.flash *= 0.8;

    // ノーツ（泡）
    state.notes.forEach(n => {
      if (n.judged) return;
      const dt = n.t - nowSec;
      if (dt < -0.2) { n.judged = true; state.combo = 0; return; }
      if (dt < 0 || dt > 1.2) return;
      
      const xOff = dt * speed;
      ctx.fillStyle = "rgba(0, 210, 255, 0.6)";
      ctx.beginPath(); ctx.arc(targetX - xOff, targetY, 20, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(targetX + xOff, targetY, 20, 0, Math.PI*2); ctx.fill();
      // 泡のハイライト
      ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
      ctx.beginPath(); ctx.arc(targetX - xOff - 5, targetY - 5, 5, 0, Math.PI*2); ctx.fill();
    });

    requestAnimationFrame(loop);
  }

  function judge() {
    const nowMs = performance.now();
    if(nowMs - lastJudgeTime < 250) return; // 暴発防止
    lastJudgeTime = nowMs;

    const now = (nowMs - state.startTime) / 1000;
    let target = state.notes.find(n => !n.judged && Math.abs(now - n.t) < 0.35);
    if (target) {
      const dt = Math.abs(now - target.t);
      target.judged = true;
      if (dt < 0.1) applyJudge("PERFECT!", "#00fff2", 40, "PERFECT");
      else if (dt < 0.2) applyJudge("GREAT", "#00a2ff", 20, "GREAT");
      else applyJudge("GOOD", "#70ffeb", 10, "GOOD");
    }
  }

  btnStart.onclick = async () => {
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      await DeviceMotionEvent.requestPermission();
    }
    ovStart.classList.add("hidden");
    state.startTime = performance.now();
    state.running = true;
    buildChart();
    loop();
  };

  window.addEventListener("keydown", (e) => { if(e.code === "Space") { e.preventDefault(); judge(); } });
  
  let lastA = {x:0, y:0, z:0};
  window.addEventListener("devicemotion", (e) => {
    const acc = e.accelerationIncludingGravity || {x:0, y:0, z:0};
    const diff = Math.abs(acc.x - lastA.x) + Math.abs(acc.y - lastA.y) + Math.abs(acc.z - lastA.z);
    lastA = {x:acc.x, y:acc.y, z:acc.z};
    if(!state.running) sensBar.style.width = Math.min(100, (diff/sensitivity)*100) + "%";
    if (diff > sensitivity) judge();
  });
  window.addEventListener("touchstart", (e) => { if(state.running) { e.preventDefault(); judge(); } }, {passive:false});
})();
</script>
</body>
</html>